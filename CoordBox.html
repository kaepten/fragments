<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CoordBox</title>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>

    <script type="text/javascript" src="js/Base.js"></script>
    <script type="text/javascript" src="js/Coordinate.js"></script>
    <script type="text/javascript" src="js/Core.js"></script>
    <script type="text/javascript" src="js/Geo.js"></script>
    <script type="text/javascript" src="js/wgs84_ch1903.js"></script>
    <script type="text/javascript" src="js/latlon.js"></script>

    <link rel="stylesheet" href="css/fragment.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:600, 400,300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,200,300' rel='stylesheet' type='text/css'>

    <style>
        body {
            /*font-family: 'Open Sans', sans-serif;*/
            font-family: 'Yanone Kaffeesatz', sans-serif;
            font-weight: 300;
            font-size: 1em;
        }
    </style>
</head>
<body>


<script>

    var html_coordBox = '<li id="geoMapsCoordBox-{0}"  class="coordBox">' +
        '    <div class="clearfix main">' +
        '        <div class="marker">' +
        '            <img src="images/marker_A.png">' +
        '        </div>' +
        '        <div class="content">' +
        '            <div class="description">' +
        '                ID {0}' +
        '            </div>' +
        '            <div class="left">' +
        '                <div>' +
        '                    <a class="cmd updown"><span class="glyphicon glyphicon-chevron-down" style="display:none"></span><span class="glyphicon glyphicon-chevron-up"></span></a>' +
        '                </div>' +
        '                <div class="coordinate">' +
        '                    {1}' +
        '                </div>' +
        '            </div>' +
        '            <div>' +
        '                <a class="cmd goto"><span class="glyphicon glyphicon-map-marker"></span></a>' +
        '                <a class="cmd calc"><span class="glyphicon glyphicon-new-window"></span></a>' +
        '                <a class="cmd edit"><span class="glyphicon glyphicon-edit"></span></a>' +
        '                <a class="cmd del"><span class="glyphicon glyphicon-remove-circle"></span></a>' +
        '                <div>' +
        '                    <a class="cmd order"><span class="fa fa-navicon"></span></a>' +
        '                </div>' +
        '                <div>' +
        '                    <a class="cmd fav"><span class="glyphicon glyphicon-heart-empty"></span><span style="display: none;" class="glyphicon glyphicon-heart red"></span></a>' +
        '                </div>' +
        '            </div>' +
        '        </div>' +
        '    </div>' +
        '    <div class="edit" style="display: none;">' +
'<table>' +
        '   <tr>   <td> Beschreibung : </td><td><input class="coordDesc" type="text" value="ID 4 Beschreibung"> </td></tr>' +
        '  <tr>   <td>     Koordinate : </td><td><input class="coordValue" type="text" value=""> </td></tr>' +
            '  <tr>   <td> </td><td> <button type="button" class="btn btn-default btn-xs save">Speichern</button>  <button type="button" class="btn btn-default btn-xs cancel">Verwerfen</button></td></tr>' +
'</table>' +
        '    </div>' +
        '    <div class="ext" style="display:none">' +
        '        <table>{2}' +
        '        </table>' +
        '    </div>' +
        '</li>';

    var extPoints = '<tr class="projectionPoint-{0}">' +
        '   <td><i class="fa fa-level-up fa-rotate-90 fa-lg"></i></td>' +
        '   <td class="pointId">{0}</td>' +
        '   <td><i class="fa fa-arrows-h"></i></td>' +
        '   <td><span  class="dist">{1}</span>km</td>' +
        '   <td><i class="fa fa-location-arrow"></i></td>' +
        '   <td><span class="angle">{2}</span>°</td>' +
        '   <td class="commands"><a class="cmd goto"><span class="glyphicon glyphicon-map-marker"></span></a> <a class="cmd showhide"><span class="glyphicon glyphicon-eye-close"></span><span style="display: none;" class="glyphicon glyphicon-eye-open green"></span></a></td>' +
        '</tr>';



    $(document).ready(function () {

        var foundCoords = ParseCoordinates();
        var pointCount = foundCoords.length;
        for (var i = 0; i < pointCount; i++) {
            var ext = "";
            var p1 = new LatLon(Number(foundCoords[i].Dec.Lat.Degree), Number(foundCoords[i].Dec.Lon.Degree));
            for (var ii = 0; ii < pointCount; ii++) {
                if(i!=ii) {
                    var p2 = new LatLon(Number(foundCoords[ii].Dec.Lat.Degree), Number(foundCoords[ii].Dec.Lon.Degree));
                    var dist = p1.distanceTo(p2);          // in km
                    var brng = p1.bearingTo(p2);
                    ext = ext + extPoints.format(ii,dist,Math.round(brng*10)/10);
                }
            }
            var box = html_coordBox.format(i, foundCoords[i].Lv03.Format, ext);
            $(".cordBoxList").append(box);
        }

        function UpdateCoordinate(id, coord)
        {
            foundCoords[id] = coord;
            var pointCount = foundCoords.length;
            for (var i = 0; i < pointCount; i++) {
                var p1 = new LatLon(Number(foundCoords[i].Dec.Lat.Degree), Number(foundCoords[i].Dec.Lon.Degree));
                $("#geoMapsCoordBox-"+i).find('.coordinate').html(foundCoords[i].Lv03.Format);
                for (var ii = 0; ii < pointCount; ii++) {
                    if(i!=ii) {
                        var p2 = new LatLon(Number(foundCoords[ii].Dec.Lat.Degree), Number(foundCoords[ii].Dec.Lon.Degree));
                        var dist = p1.distanceTo(p2);          // in km
                        var brng = p1.bearingTo(p2);

                        $("#geoMapsCoordBox-"+i).find('.projectionPoint-'+ii+' .dist').html(dist);
                        $("#geoMapsCoordBox-"+i).find('.projectionPoint-'+ii+' .angle').html(Math.round(brng*10)/10);
                    }
                }
            }
        }

        function GetCoordId(element) {
            var idElement = $(element).closest('[id^=geoMapsCoordBox-]');
            var currentId = $(idElement).attr('id');
            var myRegexp = /.*?-(\d)+/i;
            var match = myRegexp.exec(currentId);
            return match[1];
        }

        $("[id^=geoMapsCoordBox-] .updown").click(function () {

            var id = GetCoordId(this);

            $(this).closest('[id^=geoMapsCoordBox-]').find('.ext').toggle();
            $(this).find('.glyphicon-chevron-down').toggle();
            $(this).find('.glyphicon-chevron-up').toggle();
        });

        $("[id^=geoMapsCoordBox-] .fav").click(function () {
            $(this).find('.glyphicon-heart-empty').toggle();
            $(this).find('.glyphicon-heart').toggle();
        });

        $("[id^=geoMapsCoordBox-] .showhide").click(function () {
            $(this).find('.glyphicon-eye-close').toggle();
            $(this).find('.glyphicon-eye-open').toggle();
        });

        $("a.edit").click(function () {
            $('div.edit').find('input.coordDesc').val($(this).closest('.coordBox').find('.description').html().trim());
            $('div.edit').find('input.coordValue').val($(this).closest('.coordBox').find('.coordinate').html().trim());
            $(this).closest('.coordBox').find('div.edit').toggle();
        });

        $("div.edit .cancel").click(function () {
            $(this).closest('.coordBox').find('div.edit').toggle();
        });

        function SaveEditValues(element)
        {
            var coord = new Coordinate($(element).closest('div.edit').find('input.coordValue').val());
            if (!coord.IsValid) {
                alert('FEHLER beim Parsen der Eingabe!');
                $('div.edit').find('input.coordValue').val($(element).closest('.coordBox').find('.coordinate').html().trim());
                return;
            }
            UpdateCoordinate(GetCoordId(element), coord);
            $(element).closest('.coordBox').find('.description').html($(element).closest('div.edit').find('input.coordDesc').val());
            $(element).closest('.coordBox').find('div.edit').toggle();
        }

        $("div.edit .save").click(function(){
            SaveEditValues(this);
        });

        $('div.edit').find('input.coordDesc').keyup(function(e){
            if(e.keyCode == 13)
            {
                $(this).trigger("enterKey");
                SaveEditValues(this);
            }
        });

        $('div.edit').find('input.coordValue').keyup(function(e){
            if(e.keyCode == 13)
            {
                $(this).trigger("enterKey");
                SaveEditValues(this);
            }
        });

        $("a.allShowHide").click(function () {
            var showElements = $(".coordBox .ext .showhide");
            for (var i = 0; i < showElements.length; i++) {
                var elO = showElements.eq(i).find(".glyphicon-eye-open");
                var elC = showElements.eq(i).find(".glyphicon-eye-close");
                if (elO.css("display") != "none") {
                    elO.toggle();
                    elC.toggle();
                }
            }
        });

        $("a.allUpDown").click(function () {
            var downElements = $(".coordBox .ext");
            for (var i = 0; i < downElements.length; i++) {
                var element = downElements.eq(i);
                if (element.css("display") != "none") {
                    element.css("display", "none");
                }
            }
            var downIcon = $(".coordBox .updown");
            for (var i = 0; i < downIcon.length; i++) {
                var element = downIcon.eq(i);
                if ($(element).find('.glyphicon-chevron-down').css("display") == "inline-block") {
                    $(element).find('.glyphicon-chevron-up').toggle();
                    $(element).find('.glyphicon-chevron-down').toggle();
                }
            }
        });
    });

    $(function () {
        $(".cordBoxList").sortable();
    });
</script>


<div style="background-color: cadetblue;">
    <div class="gM calculator reset">
        <div class="header clearfix">
            <div class="left">
                <input type="text" value="N 46° 50.796′ E 008° 27.736′">
            </div>
            <div class="left">
                <a class="cmd newCoord"><span class="fa fa-compass"></span></a>
            </div>
            <div class="right">
                <a class="cmd allShowHide"><span class="glyphicon glyphicon-eye-close"></span></a>
                <a class="cmd allUpDown"><span class="glyphicon glyphicon-chevron-up"></span></a>
                <a class="cmd allDelete"><span class="glyphicon glyphicon-remove-circle"></span></a>
            </div>
        </div>
        <ul class="cordBoxList">        </ul>
    </div>
</div>


<div style="background-color: cadetblue; padding: 50px">

    <!-- original -->
    <div>
        <p>Overflow-Methode</p>

        <div class="clearfix">
            <div class="float-left">
                <p>
                    N 47° 16.658 E 008° 26.770
                </p>
            </div>
            <div class="float-right">
                <p>fast 90°</p>
                <p>
                    N 47° 16.654 E 008° 27.246
                   </p>
            </div>
        </div>
        <p>fast 180°</p>
        <p>N 47° 16.215 E 008° 26.838</p>
        <p>knapp 200°</p>
        <p>N 47° 16.871 E 008° 26.155</p>
        <p>N 48° 16.098′ E 007° 11.785′</p>
    </div>
</div>
</body>
</html>