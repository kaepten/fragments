<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CoordBox</title>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>

    <script type="text/javascript" src="js/Base.js"></script>
    <script type="text/javascript" src="js/Coordinate.js"></script>
    <script type="text/javascript" src="js/Core.js"></script>
    <script type="text/javascript" src="js/Geo.js"></script>
    <script type="text/javascript" src="js/wgs84_ch1903.js"></script>
    <script type="text/javascript" src="js/latlon.js"></script>
    <script type="text/javascript" src="js/settings.js"></script>

    <link rel="stylesheet" href="css/fragment.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:600, 400,300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,200,300' rel='stylesheet' type='text/css'>

    <style>
        body {
            /*font-family: 'Open Sans', sans-serif;*/
            font-family: 'Yanone Kaffeesatz', sans-serif;
            font-weight: 300;
            font-size: 1em;
        }
    </style>
</head>
<body>


<script>

var html_coordBox = '<li id="geoMapsCoordBox-{0}"  class="coordBox">' +
        '    <div class="clearfix main">' +
        '        <div class="marker">' +
        '            <img src="media/coordMarker.svg" alt="">{4}' +
        '        </div>' +
        '        <div class="content">' +
        '            <div class="description">' +
        '               {3}' +
        '            </div>' +
        '            <div class="left">' +
        '                <div>' +
        '                    <a class="cmd updown"><span class="glyphicon glyphicon-chevron-down" style="display:none"></span><span class="glyphicon glyphicon-chevron-up"></span></a>' +
        '                </div>' +
        '                <div class="coordinate">' +
        '                    {1}' +
        '                </div>' +
        '            </div>' +
        '            <div>' +
        '                <a class="cmd goto"><span class="glyphicon glyphicon-map-marker"></span></a>' +
        '                <a class="cmd calc"><span class="glyphicon glyphicon-new-window"></span></a>' +
        '                <a class="cmd edit"><span class="glyphicon glyphicon-edit"></span></a>' +
        '                <a class="cmd del"><span class="glyphicon glyphicon-remove-circle"></span></a>' +
        '                <div>' +
        '                    <a class="cmd order"><span class="fa fa-navicon"></span></a>' +
        '                </div>' +
        '                <div>' +
        '                    <a class="cmd fav"><span class="glyphicon glyphicon-heart-empty"></span><span style="display: none;" class="glyphicon glyphicon-heart red"></span></a>' +
        '                </div>' +
        '            </div>' +
        '        </div>' +
        '    </div>' +
        '    <div class="edit" style="display: none;">' +
        '       <table>' +
        '           <tr><td>Beschreibung : </td><td><input class="coordDesc" type="text" value=""> </td></tr>' +
        '           <tr><td>Koordinate : </td><td><input class="coordValue" type="text" value=""> </td></tr>' +
        '           <tr><td></td><td> <button type="button" class="btn btn-default btn-xs save">Speichern</button>  <button type="button" class="btn btn-default btn-xs cancel">Verwerfen</button></td></tr>' +
        '       </table>' +
        '    </div>' +
        '    <div class="ext" style="display: none;">' +
        '        <table>{2}' +
        '        </table>' +
        '    </div>' +
        '</li>';

var extPoints = '<tr class="projectionPoint-{0}">' +
        '   <td><i class="fa fa-level-up fa-rotate-90 fa-lg"></i></td>' +
        '   <td class="pointId">{3}</td>' +
        '   <td><i class="fa fa-arrows-h"></i></td>' +
        '   <td><span  class="dist">{1}</span>km</td>' +
        '   <td><i class="fa fa-location-arrow"></i></td>' +
        '   <td><span class="angle">{2}</span>°</td>' +
        '   <td class="commands"><a class="cmd goto"><span class="glyphicon glyphicon-map-marker"></span></a> <a class="cmd showhide"><span class="glyphicon glyphicon-eye-close"></span><span style="display: none;" class="glyphicon glyphicon-eye-open green"></span></a></td>' +
        '</tr>';

var qualityMarker = '<i class="fa fa-adjust mid green" style="display: none;"></i><i class="fa fa-circle low orange" style="display: none;"></i><i class="fa fa-circle high green" style="display: none;"></i>&nbsp;{0}';

var siteCoords;
var geoMapsSettings;
var coordFormat;

$(document).ready(function () {
    InitUI();
    AppendDocumentHandler();
});

function AppendCoordBoxHandler() {

    $("[id^=geoMapsCoordBox-] .updown").click(function () {
        var id = GetCoordId(this);
        var el = $(this).closest('[id^=geoMapsCoordBox-]').find('.ext');
        if (SettingSite.GetSettingCoordObject(geoMapsSettings, id).isExpandet) {
            el.hide(200);
        } else {
            el.show(200);
        }
        $(this).find('.glyphicon-chevron-down').toggle();
        $(this).find('.glyphicon-chevron-up').toggle();
        SettingCoord.SetExpandet(geoMapsSettings, id, !SettingSite.GetSettingCoordObject(geoMapsSettings, id).isExpandet);
    });

    $("[id^=geoMapsCoordBox-] .fav").click(function () {
        var id = GetCoordId(this);
        $(this).find('.glyphicon-heart-empty').toggle();
        $(this).find('.glyphicon-heart').toggle();
        SettingCoord.SetFavorite(geoMapsSettings, id, !SettingSite.GetSettingCoordObject(geoMapsSettings, id).isSiteFavorite);
    });

    $("[id^=geoMapsCoordBox-] .showhide").click(function () {
        $(this).find('.glyphicon-eye-close').toggle();
        $(this).find('.glyphicon-eye-open').toggle();
        var coordId = GetCoordId(this);
        var projectionId = GetProjectionId(this); // gegenseite auch ein/ausblenden
        $('#geoMapsCoordBox-' + projectionId + ' .projectionPoint-' + coordId + ' .glyphicon-eye-close').toggle();
        $('#geoMapsCoordBox-' + projectionId + ' .projectionPoint-' + coordId + ' .glyphicon-eye-open').toggle();
        SettingSite.SetProjectionShowLineTo(geoMapsSettings, coordId, projectionId);
    });

    $("a.edit").click(function () {
        var id = GetCoordId(this);
        var coordObj = SettingSite.GetSettingCoordObject(geoMapsSettings, id);
        $(this).closest('.coordBox').find('input.coordValue').val(coordObj.coordinate.OriginCoordinateString);
        $(this).closest('.coordBox').find('input.coordDesc').val(coordObj.description);
        var el = $(this).closest('.coordBox').find('div.edit');
        if (el.is(":visible")) {
            el.hide(200);
        } else {
            el.show(200);
        }
    });

    $("a.del").click(function () {
        var id = GetCoordId(this);
        SettingSite.DeleteCoord(geoMapsSettings, id);
        $("[id^=geoMapsCoordBox-" + id + "]").remove();
    });

    $("div.edit .cancel").click(function () {
        $('div.edit').find('input.coordValue').removeClass("bgred");
        $(this).closest('.coordBox').find('div.edit').toggle();
    });

    $("div.edit .save").click(function () {
        SaveEditValues(this, coordFormat, geoMapsSettings);
    });

    $('div.edit').find('input.coordDesc').keyup(function (e) {
        if (e.keyCode == 13) {
            $(this).trigger("enterKey");
            SaveEditValues(this, coordFormat, geoMapsSettings);
        }
    });

    $('div.edit').find('input.coordValue').keyup(function (e) {
        if (e.keyCode == 13) {
            $(this).trigger("enterKey");
            SaveEditValues(this, coordFormat, geoMapsSettings);
        }
    });
}

function AppendDocumentHandler() {

    $("input[name=CoordFormat]").change(function () {
        coordFormat = GetCoordinateFormatObject($("input[name=CoordFormat]:checked").val());
        ChangeCoordinatesFormat(geoMapsSettings, coordFormat);
        SettingSite.SetCoordFormat(geoMapsSettings, coordFormat);
    });

    $("a.allShowHide").click(function () {
        var showElements = $(".coordBox .ext .showhide");
        for (var i = 0; i < showElements.length; i++) {
            var elO = showElements.eq(i).find(".glyphicon-eye-open");
            var elC = showElements.eq(i).find(".glyphicon-eye-close");
            if (elO.css("display") != "none") {
                elO.toggle();
                elC.toggle();
            }
        }
        SettingSite.HideAllShowLineTo(geoMapsSettings);
    });

    $("a.delSettings").click(function () {
        DeleteGeoMapsSettings();
    });

    $("a.allDelete").click(function () {
        if (Confirm('Sollen alle Koordinaten aus dem Calculator entfernt werden?\r\nDie Seite muss neu geladen werden um die vorhanenen Koordinaten wieder zu erkennen.')) {
            var ids = [];
            for (var coordIndex = 0; coordIndex < geoMapsSettings.siteSetting.coordSettings.length; coordIndex++) {
                if (!geoMapsSettings.siteSetting.coordSettings[coordIndex].isSiteFavorite) {
                    ids.push(geoMapsSettings.siteSetting.coordSettings[coordIndex].id);
                }
            }
            for (var idIndex = 0; idIndex < ids.length; idIndex++) {
                SettingSite.DeleteCoord(geoMapsSettings, ids[idIndex]);
                $("[id^=geoMapsCoordBox-" + ids[idIndex] + "]").remove();
            }
        } else {
            // Do nothing!
        }

    });

    $("a.allUpDown").click(function () {
        var downElements = $(".coordBox .ext");
        for (var i = 0; i < downElements.length; i++) {
            var element = downElements.eq(i);
            if (element.css("display") != "none") {
                element.css("display", "none");
            }
            var id = GetCoordId(element);
            SettingCoord.SetExpandet(geoMapsSettings, id, false);
        }
        var downIcon = $(".coordBox .updown");
        for (var i = 0; i < downIcon.length; i++) {
            var element = downIcon.eq(i);
            if ($(element).find('.glyphicon-chevron-down').css("display") == "inline-block") {
                $(element).find('.glyphicon-chevron-up').toggle();
                $(element).find('.glyphicon-chevron-down').toggle();
            }
        }
    });

    $("a.newCoord").click(function () {
        errorFlag = true;
        addNew();
    });

    $("#newCoordinate").keyup(function (e) {
        if (e.keyCode == 13) {
            $(this).trigger("enterKey");
            errorFlag = true;
            addNew();
        } else {
            errorFlag = false;
        }
    });

    errorFlag = true;
    function addNew() {
        var newCoord = new Coordinate($("#newCoordinate").val());
        if (newCoord.IsValid || $("#newCoordinate").val().trim().length == 0) {
            $("#newCoordinate").removeClass("bgred");
            if ($("#newCoordinate").val().trim().length == 0) return;
            var newGUID = getGUID();
            var uiId = GetUiId();
            var siteCoord = new SettingCoord(newCoord.OriginCoordinateString, newGUID, uiId);

            AddNewCoordinateObject([siteCoord], geoMapsSettings);

            $("[id^=geoMapsCoordBox-]").remove();
            RenderCoordinatesToPageHTML(geoMapsSettings);
            AppendCoordBoxHandler();
            $("#newCoordinate").val('');
        } else {
            $("#newCoordinate").addClass("bgred");
            setTimeout(function () {
                console.log("error : " + errorFlag);
                if (errorFlag) {
                    $("#newCoordinate").val('');
                }
                $("#newCoordinate").removeClass("bgred");
            }, 2000);
            return;
        }
    }
}

$(function () {
    $(".cordBoxList").sortable({
        stop: function (event, ui) {
        },
        start: function (event, ui) {
        }
    });

    $(".cordBoxList").on("sortstop", function (event, ui) {
        // console.log('stop: '+ui.item.index());
    });

    $(".cordBoxList").on("sortstart", function (event, ui) {
        // console.log('start: '+ui.item.index());
    });
});

</script>

<div id="GeoMapsCalculator" class="gM calculator reset">
    <div class="header">
        <div class="clearfix">
            <div class="left">
                <input id="newCoordinate" type="text" value="">
            </div>
            <div class="left">
                <a class="cmd newCoord"><span class="fa fa-compass"></span></a>
            </div>
            <div class="right">
                <a class="cmd allShowHide"><span class="glyphicon glyphicon-eye-close"></span></a>
                <a class="cmd allUpDown"><span class="glyphicon glyphicon-chevron-up"></span></a>
                <a class="cmd allDelete"><span class="glyphicon glyphicon-remove-circle"></span></a>
            </div>
        </div>
        <div>
            <input type="radio" name="CoordFormat" value="LV03">SwissGrid
            <input type="radio" name="CoordFormat" value="Dms">Dms
            <input type="radio" name="CoordFormat" value="Ddd">Ddd
            <input type="radio" name="CoordFormat" value="Dmm">Dmm
        </div>
        <div>
            <a class="cmd delSettings">Alle Settings löschen</a>
        </div>
    </div>
    <ul class="cordBoxList"></ul>
</div>

<div style="background-color: #6495ed; border: 1px dashed #C0C0C0; margin: 0px 26em 1em 1em; bottom:1em; height: 600px">
    <h2>GeoAdmin map</h2>
    <script src="http://api3.geo.admin.ch/loader.js?lang=en" type="text/javascript"></script>

    <div id="map" style="height: 400px;width: 100%">
        <div id="popup" class="ol-popup" style="background-color: #ffffff;padding: 10px;">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div>
    </div>
    <div id="mouse-position" class="mouse-position" style="position: fixed; top: 35px; left: 200px;"></div>

    <div class="catalog-container">
        <a class="checkbox-tree" unselectable="on">Bundesinventare</a>
        <div class="checkbox-inhalt"></div>
    </div>

    <script type="text/javascript">

        var container = document.getElementById('popup');
        var content = document.getElementById('popup-content');
        var closer = document.getElementById('popup-closer');
        closer.onclick = function() {
            container.style.display = 'none';
            closer.blur();
            return false;
        };
        var overlay = new ol.Overlay({
            element: container
        });

        var layers ={};
        $.displayLayer = function(layerBodId, visible) {
            layers[layerBodId].setVisible(visible);
        };

        $.getLegend = function(layerBodId) {
            var modalBody = $('#legend-modal').find('.modal-body');
            modalBody.empty();
            // Use JSONP for IE9
            $.ajax({
                url: location.protocol + '//api3.geo.admin.ch/rest/services/api/MapServer/' + layerBodId + '/legend?lang=de',
                jsonp: "callback",
                dataType: "jsonp",
                success: function(data) {
                    modalBody.append(data);
                }
            });
        };

        var layer = ga.layer.create('ch.swisstopo.pixelkarte-farbe');
        var map = new ga.Map({
            target: 'map',
            layers: [layer],
            overlays: [overlay],
            view: new ol.View2D({
                resolution: 2,
                center: [678959, 236020]
            })
        });

        map.on('click', function(evt) {
            var coordinate = evt.coordinate;
            // var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326'));
            var template = '{x} {y}';
            // var out = ol.coordinate.toStringXY(coordinate);
            var out = '';
            var hdms = ol.coordinate.format(coordinate, template);


            overlay.setPosition(coordinate);
            content.innerHTML = '<p>' + hdms +
            '<br>'+out+'</p>';
            container.style.display = 'block';

        });

        var mousePositionControl = new ol.control.MousePosition({
            coordinateFormat: ol.coordinate.createStringXY(0),
            projection: 'EPSG:21781',
            className: 'custom-mouse-position',
            target: document.getElementById('mouse-position'),
            undefinedHTML: '&nbsp;'
        });

        map.addControl(mousePositionControl);

        var tpl =
                '<div class="checkbox">' +
                '<label>{label}' +
                '<input type="checkbox" onclick="$.displayLayer(\'{layerBodId}\', this.checked)"/>' +
                '</label>' + '<button onclick="$.getLegend(\'{layerBodId}\')" class="btn btn-default legend-btn" data-toggle="modal" data-target="#legend-modal">i</button>'
        '</div>';

        var nano = function(template, data) {
            return template.replace(/\{([\w\.]*)\}/g,
                    function (str, key) {
                        var keys = key.split("."), value = data[keys.shift()];
                        $.each(keys, function () {
                            value = value[this];
                        });
                        return (value === null || value === undefined) ? "" : value;
                    }
            );
        };

        $('.checkbox-tree').bind('click', function(evt) {
            var display = $('.checkbox-inhalt').css('display');
            if (display === 'block') {
                $('.checkbox-inhalt').hide();
            } else {
                $('.checkbox-inhalt').show();
            }
        });

        var catalogConfig = [
            {layerBodId: 'ch.bafu.bundesinventare-amphibien', label: 'Amphibien Ortsfeste Objekte'},
            {layerBodId: 'ch.bafu.bundesinventare-amphibien_wanderobjekte', label: 'Amphibien Wanderobjekte'},
            {layerBodId: 'ch.bafu.wrz-wildruhezonen_portal', label: 'Wildruhezonen'}
        ];

        for (var i=0; i < catalogConfig.length; i++) {
            var item = catalogConfig[i];
            $('.checkbox-inhalt').append(nano(tpl, item));
            layers[item.layerBodId] = ga.layer.create(item.layerBodId);
            layers[item.layerBodId].setVisible(false);
            map.addLayer(layers[item.layerBodId]);
        }

    </script>
    <div>
        <p>Bank: N 47° 16.654 E 008° 88.22 Parkplatz: N 47° 16.654 E 008° 77.77</p>
    </div>
</div>

</body>
</html>